<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>API 5: Grid &mdash; Kolmogorov Arnold Network  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API 6: Training Hyperparamters" href="API_6_training_hyperparameter.html" />
    <link rel="prev" title="API 4: Initialization" href="API_4_initialization.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Kolmogorov Arnold Network
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Hello, KAN!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../demos.html">API Demos</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="API_1_indexing.html">API 1: Indexing</a></li>
<li class="toctree-l2"><a class="reference internal" href="API_2_plotting.html">API 2: Plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="API_3_extract_activations.html">API 3: Extracting activation functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="API_4_initialization.html">API 4: Initialization</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">API 5: Grid</a></li>
<li class="toctree-l2"><a class="reference internal" href="API_6_training_hyperparameter.html">API 6: Training Hyperparamters</a></li>
<li class="toctree-l2"><a class="reference internal" href="API_7_pruning.html">API 7: Pruning</a></li>
<li class="toctree-l2"><a class="reference internal" href="API_8_regularization.html">API 8: Regularization</a></li>
<li class="toctree-l2"><a class="reference internal" href="API_9_video.html">API 9: Videos</a></li>
<li class="toctree-l2"><a class="reference internal" href="API_10_device.html">Demo 10: Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="API_11_create_dataset.html">API 11: Create dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="API_12_checkpoint_save_load_model.html">API 12: Checkpoint, save &amp; load model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Kolmogorov Arnold Network</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../demos.html">API Demos</a></li>
      <li class="breadcrumb-item active">API 5: Grid</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/API_demo/API_5_grid.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="api-5-grid">
<h1>API 5: Grid<a class="headerlink" href="#api-5-grid" title="Link to this heading"></a></h1>
<p>One important feature of KANs is that they embed splines to neural
networks. However, splines are only valid for approximating functions in
known bounded regions, while the range of activations in neural networks
may be changing over training. So we have to update grids properly
according to that. Let’s first take a look at how we parametrize
splines.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from kan.spline import B_batch
import torch
import matplotlib.pyplot as plt
import numpy as np
from kan.spline import extend_grid

# consider a 1D example.
# Suppose we have grid in [-1,1] with G intervals, spline order k
G = 5
k = 3
grid = torch.linspace(-1,1,steps=G+1)[None,:]
grid = extend_grid(grid, k_extend=k)

# and we have sample range in [-1,1]
x = torch.linspace(-1,1,steps=1001)[None,:]

basis = B_batch(x, grid, k=k)

for i in range(G+k):
    plt.plot(x[0].detach().numpy(), basis[0,:,i].detach().numpy())

plt.legend([&#39;B_{}(x)&#39;.format(i) for i in np.arange(G+k)])
plt.xlabel(&#39;x&#39;)
plt.ylabel(&#39;B_i(x)&#39;)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;B_i(x)&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/API_5_grid_2_1.png" src="../_images/API_5_grid_2_1.png" />
<p>There are <span class="math notranslate nohighlight">\(G+k\)</span> B-spline basis. The function is a linear
combination of these bases</p>
<div class="math notranslate nohighlight">
\[{\rm spline}(x)=\sum_{i=0}^{G+k-1} c_i B_i(x).\]</div>
<p>We don’t need worry about the implementation since it’s already built
in KAN. But let’s check if KAN is indeed implementing this. We
initialize a [1,1] KAN, which is simply a 1D spline.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from kan import KAN

model = KAN(width=[1,1], grid=G, k=k)
# obtain coefficients c_i
model.act_fun[0].coef
assert(model.act_fun[0].coef[0].shape[1] == G+k)

# the model forward
model_output = model(x[0][:,None])

# spline output
spline_output = torch.einsum(&#39;j,ij-&gt;i&#39;,model.act_fun[0].coef[0][0], basis[0])[:,None]

torch.mean((model_output - spline_output)**2)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">checkpoint</span> <span class="n">directory</span> <span class="n">created</span><span class="p">:</span> <span class="o">./</span><span class="n">model</span>
<span class="n">saving</span> <span class="n">model</span> <span class="n">version</span> <span class="mf">0.0</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0099</span><span class="p">,</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">MeanBackward0</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>They are not the same, what’s happening? We want to remind that we model
the activation function to have two additive parts, a residual function
<span class="math notranslate nohighlight">\(b\)</span>(x) plus the spline function, i.e.,</p>
<div class="math notranslate nohighlight">
\[\phi(x)={\rm scale\_base}*b(x)+{\rm scale\_sp}*{\rm spline}(x),\]</div>
<p>and by default <span class="math notranslate nohighlight">\(b(x)={\rm silu}(x)=x/(1+e^{-x})\)</span>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># residual output
residual_output = torch.nn.SiLU()(x[0][:,None])
scale_base = model.act_fun[0].scale_base
scale_sp = model.act_fun[0].scale_sp
torch.mean((model_output - (scale_base * residual_output + scale_sp * spline_output))**2)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">MeanBackward0</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>What if my grid does not match my data? For example, my grid is in
[-1,1], but my data is in [10,10] or [-0.5,0.5]. Use
update_grid_from_sample to adjust grids to samples. This grid update
applies to all splines in all layers.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>model = KAN(width=[1,1], grid=G, k=k)
print(model.act_fun[0].grid) # by default, the grid is in [-1,1]
x = torch.linspace(-10,10,steps = 1001)[:,None]
model.update_grid_from_samples(x)
print(model.act_fun[0].grid) # now the grid becomes in [-10,10]. We add a 0.01 margin in case x have zero variance
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">checkpoint</span> <span class="n">directory</span> <span class="n">created</span><span class="p">:</span> <span class="o">./</span><span class="n">model</span>
<span class="n">saving</span> <span class="n">model</span> <span class="n">version</span> <span class="mf">0.0</span>
<span class="n">Parameter</span> <span class="n">containing</span><span class="p">:</span>
<span class="n">tensor</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.2000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2000</span><span class="p">,</span>  <span class="mf">0.2000</span><span class="p">,</span>  <span class="mf">0.6000</span><span class="p">,</span>
          <span class="mf">1.0000</span><span class="p">,</span>  <span class="mf">1.4000</span><span class="p">,</span>  <span class="mf">1.8000</span><span class="p">,</span>  <span class="mf">2.2000</span><span class="p">]])</span>
<span class="n">Parameter</span> <span class="n">containing</span><span class="p">:</span>
<span class="n">tensor</span><span class="p">([[</span><span class="o">-</span><span class="mf">22.</span><span class="p">,</span> <span class="o">-</span><span class="mf">18.</span><span class="p">,</span> <span class="o">-</span><span class="mf">14.</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.</span><span class="p">,</span>  <span class="o">-</span><span class="mf">6.</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.</span><span class="p">,</span>   <span class="mf">2.</span><span class="p">,</span>   <span class="mf">6.</span><span class="p">,</span>  <span class="mf">10.</span><span class="p">,</span>  <span class="mf">14.</span><span class="p">,</span>  <span class="mf">18.</span><span class="p">,</span>  <span class="mf">22.</span><span class="p">]])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>model = KAN(width=[1,1], grid=G, k=k)
print(model.act_fun[0].grid) # by default, the grid is in [-1,1]
x = torch.linspace(-0.5,0.5,steps = 1001)[:,None]
model.update_grid_from_samples(x)
print(model.act_fun[0].grid) # now the grid becomes in [-10,10]. We add a 0.01 margin in case x have zero variance
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">checkpoint</span> <span class="n">directory</span> <span class="n">created</span><span class="p">:</span> <span class="o">./</span><span class="n">model</span>
<span class="n">saving</span> <span class="n">model</span> <span class="n">version</span> <span class="mf">0.0</span>
<span class="n">Parameter</span> <span class="n">containing</span><span class="p">:</span>
<span class="n">tensor</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.2000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2000</span><span class="p">,</span>  <span class="mf">0.2000</span><span class="p">,</span>  <span class="mf">0.6000</span><span class="p">,</span>
          <span class="mf">1.0000</span><span class="p">,</span>  <span class="mf">1.4000</span><span class="p">,</span>  <span class="mf">1.8000</span><span class="p">,</span>  <span class="mf">2.2000</span><span class="p">]])</span>
<span class="n">Parameter</span> <span class="n">containing</span><span class="p">:</span>
<span class="n">tensor</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.1000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.9000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1000</span><span class="p">,</span>  <span class="mf">0.1000</span><span class="p">,</span>  <span class="mf">0.3000</span><span class="p">,</span>
          <span class="mf">0.5000</span><span class="p">,</span>  <span class="mf">0.7000</span><span class="p">,</span>  <span class="mf">0.9000</span><span class="p">,</span>  <span class="mf">1.1000</span><span class="p">]])</span>
</pre></div>
</div>
<p>Uniform grid or non-uniform? We consider two options: (1) uniform grid;
(2) adaptive grid (based on sample distribution) such that there are
(rougly) same number of samples in each interval. We provide a parameter
grid_eps to interpolate between these two regimes. grid_eps = 1 gives
(1), and grid_eps = 0 gives (0). By default we set grid_eps = 1 (uniform
grid). There could be other options but it is out of our scope here.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># uniform grid
model = KAN(width=[1,1], grid=G, k=k)
print(model.act_fun[0].grid) # by default, the grid is in [-1,1]
x = torch.normal(0,1,size=(1000,1))
model.update_grid_from_samples(x)
print(model.act_fun[0].grid) # now the grid becomes in [-10,10]. We add a 0.01 margin in case x have zero variance
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">checkpoint</span> <span class="n">directory</span> <span class="n">created</span><span class="p">:</span> <span class="o">./</span><span class="n">model</span>
<span class="n">saving</span> <span class="n">model</span> <span class="n">version</span> <span class="mf">0.0</span>
<span class="n">Parameter</span> <span class="n">containing</span><span class="p">:</span>
<span class="n">tensor</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.2000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2000</span><span class="p">,</span>  <span class="mf">0.2000</span><span class="p">,</span>  <span class="mf">0.6000</span><span class="p">,</span>
          <span class="mf">1.0000</span><span class="p">,</span>  <span class="mf">1.4000</span><span class="p">,</span>  <span class="mf">1.8000</span><span class="p">,</span>  <span class="mf">2.2000</span><span class="p">]])</span>
<span class="n">Parameter</span> <span class="n">containing</span><span class="p">:</span>
<span class="n">tensor</span><span class="p">([[</span><span class="o">-</span><span class="mf">8.3431</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.8772</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.4114</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.9455</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.4797</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0138</span><span class="p">,</span>  <span class="mf">0.4520</span><span class="p">,</span>  <span class="mf">1.9179</span><span class="p">,</span>
          <span class="mf">3.3837</span><span class="p">,</span>  <span class="mf">4.8496</span><span class="p">,</span>  <span class="mf">6.3154</span><span class="p">,</span>  <span class="mf">7.7813</span><span class="p">]])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># adaptive grid based on sample distribution
model = KAN(width=[1,1], grid=G, k=k, grid_eps = 0.)
print(model.act_fun[0].grid) # by default, the grid is in [-1,1]
x = torch.normal(0,1,size=(1000,1))
model.update_grid_from_samples(x)
print(model.act_fun[0].grid) # now the grid becomes in [-10,10]. We add a 0.01 margin in case x have zero variance
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">checkpoint</span> <span class="n">directory</span> <span class="n">created</span><span class="p">:</span> <span class="o">./</span><span class="n">model</span>
<span class="n">saving</span> <span class="n">model</span> <span class="n">version</span> <span class="mf">0.0</span>
<span class="n">Parameter</span> <span class="n">containing</span><span class="p">:</span>
<span class="n">tensor</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.2000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6000</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2000</span><span class="p">,</span>  <span class="mf">0.2000</span><span class="p">,</span>  <span class="mf">0.6000</span><span class="p">,</span>
          <span class="mf">1.0000</span><span class="p">,</span>  <span class="mf">1.4000</span><span class="p">,</span>  <span class="mf">1.8000</span><span class="p">,</span>  <span class="mf">2.2000</span><span class="p">]])</span>
<span class="n">Parameter</span> <span class="n">containing</span><span class="p">:</span>
<span class="n">tensor</span><span class="p">([[</span><span class="o">-</span><span class="mf">8.3431</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.8772</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.4114</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.9455</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8148</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2487</span><span class="p">,</span>  <span class="mf">0.2936</span><span class="p">,</span>  <span class="mf">0.8768</span><span class="p">,</span>
          <span class="mf">3.3837</span><span class="p">,</span>  <span class="mf">4.8496</span><span class="p">,</span>  <span class="mf">6.3154</span><span class="p">,</span>  <span class="mf">7.7813</span><span class="p">]])</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="API_4_initialization.html" class="btn btn-neutral float-left" title="API 4: Initialization" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="API_6_training_hyperparameter.html" class="btn btn-neutral float-right" title="API 6: Training Hyperparamters" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Ziming Liu.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>